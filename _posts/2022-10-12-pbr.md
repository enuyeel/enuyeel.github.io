---
layout: post
title: "Physically Based Rendering (WIP)"
permalink: /blog/:year/:month/:day/:title
---

This article is still in a draft state!

<br>

***

<br>

**Preface**

<br>

It is to be noted that a single point on the surface at the macro level can be modeled as a collection of small microfacets at the micro level, hence the coin of the term Microfacet Model, and it's their aggregate behavior against the light that determines the observed light scattering. <br>
It is our interest how not just a single, but every microfacet on a differential area (a fragment) scatters any incoming lights in all different directions (technically only the directions covered by the upper hemisphere), thus a need for integrating the surface response over a hemisphere. <br>
Although we can assume that a single incoming light will hit off every microfacet within the hemisphere at the same incident angle, it is still computationally heavy to calculate integration for every shaded fragment (multiple integrations if the scene consists of more than one light source). It’s best if our surface response which consists of diffuse and specular components can effectively be boiled down to a statistical approximation. <br>
For a refresher, the moment a light ray hits a surface, it gets split into both reflection and refraction parts. Reflection is when a light ray doesn’t enter the surface and gets directly reflected, while refraction is when a light ray enters the surface and either gets absorbed or later emerges from the surface at a distance. The reflection part corresponds to the specular component, while the refraction part translates to the diffuse component. It should be mentioned that conductors (e.g purely metallic materials) have no diffuse component. <br>
There are many different versions of general microfacet model equations available online. Since my PBR implementation for the most part is based on Google Filament, I'll borrow their notations from now on unless otherwise specified. <br>

<br>

***

<br>

**Bidirectional Reflectance Distribution Function**

<br>

This is an excerpt from [Nayar21a]:
  "There are two directions that are important to us. One is the direction from which the light arrives, and the second is the direction in which light is being reflected and observed. So, to represent the reflectance properties of any material, we want to be able to describe its properties both in terms of the illumination direction and the viewing direction of the reflection direction. So, that brings us to the Bidirectional Reflectance Distribution Function."<br>
BRDF is a 4-dimensional function that takes in 2 sets of zenith and azimuth angles, where each set represents the incoming light and the outgoing viewing direction. <br>

$$f(\theta_i,\phi_i,\theta_r,\phi_r)$$

Often its parameterization is simplified with the said two vectors accordingly. It then describes the reflectance properties of a surface, or in layman's terms, surface response. <br>
The complete surface response BRDF can then be expressed as a combination of two individual BRDF terms as such:<br>

$$f(v,l)=f_d(v,l)+f_r(v,l)$$

Each of $$f_d$$ and $$f_r$$ represents the diffuse component and the specular component correspondingly, and we'll first look into the specular BRDF term $$f_r$$. <br>

$$f_r(v,l)=\frac{D(h,\alpha)G(v,l,\alpha)F(v,h,f0)}{4(n\cdot v)(n\cdot l)}$$

This form of BRDF is generally known as the Torrance-Sparrow model. There’s seemingly a lot to digest here, but I won’t go into much detail on how this formula is derived, since I can’t do justice anyway. If one’s eager to check out, [Humphreys18] has always been my go-to reference. However, I can say that a little bit of everything is involved in the derivation of this formula, notably, the definition of surface radiance and BRDF.<br>
Each of the three different terms on the numerator has its specific role for this BRDF. Before I go over them individually, it should be mentioned that the derivation itself depends on neither the particular $$D$$ term (normal distribution function) nor a particular $$F$$ term (Fresnel function), which means we can pretty much swap those terms in and out with whatever valid combinations we have. $$G$$ (Smith's masking-shadowing function) on the other hand depends on its counterpart $$D$$ function, and its derivation is well documented in [Heitz14a]. <br>

<br>

***

<br>

**Normal Distribution Function**

<br>

[Walter07] states that the (normalized) normal distribution function $$D(m)$$ should give the differential area of microfacets aligned with the directional vector $$m$$ (denoted $$dA_{m}$$) when multiplied with a couple of terms, which are as follows:<br>
(1) an infinitesimal solid angle centered on $$m$$ (denoted $$d\omega_{m}$$, which are if loosely spoken, a set of directions near $$m$$ according to [Reed13]),<br>
(2) a macrosurface $$dA$$ (beneath microfacets).<br>
It is to be noted that $$D(m)$$ is an abbreviated version of $$D(m, \alpha)$$, where $$\alpha$$ denotes the roughness parameter. To avoid further confusion, it’d be appropriate to replace $$D(m)$$ with $$D(m, \alpha)$$, and $$m$$ with half vector $$h$$ from this point and on, as it suits our implementation better.<br>

$$dA_{h}=D(h,\alpha)d\omega_{h}dA\hspace{1mm}$$

Following is a list of properties any plausible $$D(m, \alpha)$$ should obey, extracted from the same paper and slightly modified in notation for consistency:<br>

$$0\leq D(h,\alpha)\leq \infty\hspace{1mm} \cdots (1)$$

$$1\leq \int_{\Omega}^{}D(h,\alpha)d\omega_{h}\hspace{1mm} \cdots (2)$$

$$(w\cdot n)=\int_{\Omega}^{}D(h,\alpha)(w\cdot h)d\omega_{h}\hspace{1mm}\cdots(3.1)$$

$$1=\int_{\Omega}^{}D(h,\alpha)(n\cdot h)d\omega_{h}\hspace{1mm}\cdots(3.2)$$

I have to admit that was a bit harsh opener for a new section. So, what exactly is the NDF again? If were to gloss over all the nitty gritty details, it’s a weighting function for scaling the highlight of specular reflection in BRDF.<br>
In its normalized form, NDF is a probability density function (PDF, in short). PDF has the property of being non-negative everywhere, and at the same time, the area under its curve sums up to $$1$$. Due to the aforementioned properties, $$D(h,\alpha)$$ is designed to shoot up much higher than $$1$$ (hence, probability density, not probability) in a scenario where the surface is smooth (lower $$\alpha$$ value) and the half vector $$h$$ is close to the macrosurface normal $$n$$. Property $$(1)$$ implies this very characteristic.<br>
Property $$(2)$$ on the other hand, suggests that given a perfectly smooth macrosurface of an area of size $$1$$, just any microfacets heightfield (correlated or not correlated) imaginable laying on top of it will surely yield a total area of size greater than or equal to $$1$$. ~~It might be a stretch, but it might even be possible to yield a $$dA_{h}$$ of size much greater than $$1$$ if we imagine a macrosurface punctured with a bunch of infinitely small needles, overall resembling a dense forest?~~<br>
The last property $$(3.1)$$ brings up the point that the area of the microfacets aligned with $$h$$ ($$dA_{h}$$) projected to given direction $$w$$ equals the area of the macrosurface projected to the same vector when integrated over the hemisphere. $$(3.2)$$ is a special case when $$w=n$$, and is an important property that has been extensively covered in [Reed13]. It suggests that by making certain that the area of the microfacets projected directly downward (projected to $$n$$) equals the area of the macrosurface beneath them, (in other words, normalizing) it ensures the physical plausibility of the BRDF. [Humphreys18] provides a great visualization of this concept [**here**](https://www.pbr-book.org/3ed-2018/Reflection_Models/Microfacet_Models#fig:microfacet-projected-area).<br>
So, yet again, what exactly is the NDF? We now get the rough picture going in our head, but it surely is difficult to pin down its definition. Here is a list of definitions suggested by a couple of scholars, and you can choose whatever suits your liking!<br>
According to [Hoffman15]:
  "The NDF gives the concentration of microfacet normals pointing in a given direction (in this case, the half-angle direction), relative to surface area. The NDF determines the size and shape of the highlight." (p. 71)<br>
According to [Walter07]:
  "The microfacet normal distribution, $$D(m)$$, describes the statistical distribution of surface normals $$m$$ over the microsurface." (p. 3)<br>
It is finally about time to introduce an actual NDF. One can easily come across many different versions of NDF online, but I’ll be introducing the isotropic version of the Trowbridge-Reitz (GGX) distribution in this article.<br>

$$D(h,\alpha)=\frac{\alpha^2}{\pi((n\cdot h)^2(\alpha^2-1)+1)^2}$$

You can easily check out that this normalized NDF does indeed yield $$1$$ when integrated over the hemisphere (Recall the property $$(3.2)$$). Below is the slightly rephrased formula for the purpose of feeding into a computer algebra system (CAS), and my go-to choice has always been Desmos. It should be noted that the outermost integration over the azimuth angle $$\phi$$ has been replaced with multiplication by $$2\pi$$, to take into account that the isotropic version of NDF only depends on zenith angle $$\theta$$.<br>

$$D(\theta,\alpha)=\frac{\alpha^2}{\pi(cos^2(\theta)(\alpha^2-1)+1)^2}$$

$$2\pi\int_{0}^{2\pi}D(\theta,\alpha)cos(\theta)sin(\theta)d\theta=1$$

<br>

***

<br>

**Masking-Shadowing Function**

<br>

It is demonstrated in [Heitz14b] that the projected area of the microfacets onto the outgoing direction $$w$$ is the same as the sum of the projected area of the *visible* microfacets. This should sound familiar since we’ve already covered a similar concept above. Here’s the property $$(3.1)$$ from the previous section:<br>

$$(w\cdot n)=\int_{\Omega}^{}D(h,\alpha)(w\cdot h)d\omega_{h}\hspace{1mm}\cdots(3.1)$$

One thing to pay close attention to is how $$(w\cdot h)$$ here is signed, and it accounts for the back-facing microfacets when the value becomes negative, which also happens to cancel out the area of the occluded forward-facing microfacets.<br>
If we clamp the $$(w\cdot h)$$ from $$(3.1)$$ by replacing it with $$max(0, w\cdot h)$$, we can effectively nullify the area of the back-facing microfacets. Then, we introduce Smith’s (statistical) masking-shadowing function $$G_1(w, \alpha)$$, which gives the fraction of microfacets aligned with $$h$$ that are *visible* from the direction $$w$$, and it should account for every front-facing microfacets minus the occluded ones. Lastly, if we let $$\theta$$ represent the angle between the macrosurface normal $$n$$ and the outgoing projection direction $$w$$, this gives us the normalization constraint for $$G_1(w, \alpha)$$:<br>

$$cos(\theta)=(w\cdot n)=\int_{\Omega}^{}G_1(w,\alpha)max(0,w\cdot h)D(h,\alpha)d\omega_{h}\hspace{1mm}\cdots(4)$$

According to [Humphreys18], we can let $$A^+(w)$$ represent the projected area of forward-facing microfacets, and $$A^-(w)$$ represent the projected area of back-facing microfacets. With $$cos(\theta)$$ from the equation $$(4)$$, we can then yield the following relation:<br>

$$cos(\theta)=A^+(w)-A^-(w)$$

$$G_1(w, \alpha)=\frac{A^+(w)-A^-(w)}{A^+(w)}$$

We further rewrite the function $$G_1(w, \alpha)$$ by introducing an auxiliary function $$\Lambda(w)$$ which measures masked (occluded) microfacets’ area per visible microfacets’ area according to [Humphreys18]:<br>

$$\Lambda(w)=\frac{A^-(w)}{A^+(w)-A^-(w)}$$

$$\frac{1}{G_1(w,\alpha)}=\frac{A^+(w)}{A^+(w)-A^-(w)}$$

$$\frac{1}{G_1(w,\alpha)}-\Lambda(w)=\frac{A^+(w)}{A^+(w)-A^-(w)}-\frac{A^-(w)}{A^+(w)-A^-(w)}=1$$

$$1-G_1(w,\alpha)\Lambda(w)=G_1(w,\alpha)$$

$$G_1(w,\alpha)(1+\Lambda(w))=1$$

$$G_1(w,\alpha)=\frac{1}{1+\Lambda(w)}$$

Derivation of $$\Lambda(w)$$ for the isotropic Trowbridge-Reitz (GGX) distribution from the previous section is extensively explained in [Heitz14a]. Its final form is as follows:<br>

$$\Lambda(w)=\frac{-1+\sqrt{1+\alpha^2tan^2\theta}}{2}$$

With a bit of algebra chain, we can arrive at the form introduced in Filament’s official design documentation:<br>

$$=\frac{-1+\sqrt{1+\alpha^2(\frac{sin^2\theta}{cos^2\theta})}}{2}=\frac{-1+\sqrt{1+\alpha^2(\frac{1-cos^2\theta}{cos^2\theta})}}{2}=\frac{-1+\sqrt{1+\alpha^2(\frac{1-(n\cdot w)^2}{(n\cdot w)^2})}}{2}$$

$$=\frac{1}{2}(\sqrt{\frac{(n\cdot w)^2+\alpha^2-\alpha^2(n\cdot w)^2}{(n\cdot w)^2}}-1)=\frac{1}{2}(\frac{\sqrt{(n\cdot w)^2+\alpha^2-\alpha^2(n\cdot w)^2}}{n\cdot w}-1)$$

$$=\frac{1}{2}(\frac{\sqrt{\alpha^2+(1-\alpha^2)(n\cdot w)^2}}{n\cdot w}-1)$$

Now, let’s say we want to come up with a masking-shadowing function $$G(v,l,\alpha)$$ that gives the fraction of microfacets visible from both $$v$$, and $$l$$. We can start off simply by assuming that the probability of any microfacet visible from $$v$$ is independent of the probability of those visible from $$l$$:<br>

$$G(v,l,\alpha)=G_1(v,\alpha)G_1(l,\alpha)$$

According to [Humphreys18], this formulation underestimates the probability considering the case where $$v=l$$, since $$G_1(w,\alpha)\leq1$$, and it’d usually be only true if $$v$$, and $$l$$ coincides with macrosurface normal $$n$$. Generally, the closer together the two directions are the more correlation between $$G_1(v,\alpha)$$, and $$G_1(l,\alpha)$$ should exist.<br>
[Heitz14a] introduces a height-correlated masking-shadowing function, and it accounts for the assumption that the more a microfacet is elevated, the more the probabilities of being visible for both the $$v$$, and $$l$$. A more accurate joint masking-shadowing function takes the following form:<br>

$$G(v,l,\alpha)=\frac{1}{1+\Lambda(v)+\Lambda(l)}$$

Again, we perform a little bit of algebra to arrive at a more implementation-friendly form as introduced in Filament documentation:<br>

$$1+\Lambda(v)+\Lambda(l)=\frac{1}{2}(\frac{\sqrt{\alpha^2+(1-\alpha^2)(n\cdot v)^2}}{n\cdot v}+\frac{\sqrt{\alpha^2+(1-\alpha^2)(n\cdot l)^2}}{n\cdot l})$$

$$=\frac{1}{2}(\frac{(n\cdot l)\sqrt{\alpha^2+(1-\alpha^2)(n\cdot v)^2}+(n\cdot v)\sqrt{\alpha^2+(1-\alpha^2)(n\cdot l)^2}}{(n\cdot v)(n\cdot l)})$$

$$G(v,l,\alpha)=\frac{2(n\cdot v)(n\cdot l)}{(n\cdot l)\sqrt{\alpha^2+(1-\alpha^2)(n\cdot v)^2}+(n\cdot v)\sqrt{\alpha^2+(1-\alpha^2)(n\cdot l)^2}}$$

It is observed that the denominator from the Torrance-Sparrow model should cancel out nicely (for the most part) with the numerator from the formula we derived just before. Filament introduces the visibility function $$V(v,l,\alpha)$$ just for this purpose, and it takes the following form:<br>

$$V(v,l,\alpha)=\frac{G(v,l,\alpha)}{4(n\cdot v)(n\cdot l)}$$

$$=\frac{0.5}{(n\cdot l)\sqrt{\alpha^2+(1-\alpha^2)(n\cdot v)^2}+(n\cdot v)\sqrt{\alpha^2+(1-\alpha^2)(n\cdot l)^2}}$$

<br>

***

<br>

**Bibliograph**

<br>

[[**Heitz14a**]](https://jcgt.org/published/0003/02/03/paper.pdf) Eric Heitz. 2014. Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs (Paper). https://jcgt.org/published/0003/02/03/paper.pdf<br>
[[**Heitz14b**]](https://jcgt.org/published/0003/02/03/presentation.pdf) Eric Heitz. 2014. Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs (Presentation). https://jcgt.org/published/0003/02/03/presentation.pdf<br>
[[**Walter07**]](https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html) Bruce Walter et el. 2007. Microfacet Models for Refraction through Rough Surfaces. https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html<br>
[[**Reed13**]](https://www.reedbeta.com/blog/hows-the-ndf-really-defined/) Nathan Reed. 2013. How Is The NDF Really Defined?. https://www.reedbeta.com/blog/hows-the-ndf-really-defined/<br>
[[**Hoffman15**]](https://blog.selfshadow.com/publications/s2015-shading-course/hoffman/s2015_pbs_physics_math_slides.pdf) Naty Hoffman. 2015. Physics and Math of Shading. https://blog.selfshadow.com/publications/s2015-shading-course/hoffman/s2015_pbs_physics_math_slides.pdf<br>
[[**Nayar21a**]](https://youtu.be/R9iZzaXUaK4) Shree K. Nayar. 2021. BRDF: Bidirectional Reflectance Distribution Function. https://youtu.be/R9iZzaXUaK4<br>
[[**Nayar21b**]](https://youtu.be/tflz0loWhIY) Shree K. Nayar. 2021. Radiometric Concepts | Radiometry and Reflectance. https://youtu.be/R9iZzaXUaK4<br>
[[**Humphreys18**]](https://www.pbr-book.org/) Greg Humphreys et el. 2018. Physically Based Rendering:From Theory To Implementation. https://www.pbr-book.org/<br>
[[**Karis13**]](http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html) Brian Karis. 2013. Specular BRDF Reference. http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html<br>

<br>

***

<br>

**Updates**

<br>

- (02/20/23) ['Preface', ‘BRDF’, ‘NDF’, '**Masking-Shadowing Function**', '*Bibliography*’]
- (02/16/23) [~~'*Surface Radiance*'~~, 'Preface', 'BRDF’, 'NDF’, '*Bibliography*’]
- (11/03/22) ['*Surface Radiance*', '***Preface***', '***BRDF***’, '***NDF***’, '*Bibliography*’]
- (10/12/22) ['***Surface Radiance***', '***Bibliography***’]